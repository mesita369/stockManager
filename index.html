<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#b8342f">
    <title>Hotspot Restaurant - Inventory Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            min-height: 100vh;
            color: black;
        }

        .container { max-width: 1300px; margin: 0 auto; padding: 20px; }

        .header {
            text-align: center;
            padding: 30px 0;
            background: white;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(184,52,47,0.2);
        }
        .header h1 { color: #b8342f; font-size: 48px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
        .header p { color: black; font-size: 18px; font-weight: 500; }

        .date-display {
            background: #b8342f; color: white; padding: 15px 30px;
            border-radius: 15px; text-align: center; font-size: 20px;
            font-weight: 600; margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(184,52,47,0.3);
        }

        .main-buttons {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 30px; margin-bottom: 40px;
        }
        .main-button {
            background: white; border: 4px solid #b8342f;
            padding: 60px 40px; border-radius: 25px;
            font-size: 28px; font-weight: 700; color: #b8342f;
            cursor: pointer; transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .main-button:hover { background: #b8342f; color: white; transform: translateY(-5px); box-shadow: 0 15px 40px rgba(184,52,47,0.4); }
        .main-button:active { transform: translateY(-2px); }

        .form-container { display: none; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 15px 50px rgba(0,0,0,0.15); margin-bottom: 30px; }
        .form-container.active { display: block; animation: slideIn 0.3s ease-out; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .form-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #b8342f;
        }
        .form-header h2 { color: #b8342f; font-size: 32px; font-weight: 700; }
        .close-btn {
            background: #b8342f; color: white; border: none;
            padding: 12px 25px; border-radius: 10px; font-size: 16px;
            font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        .close-btn:hover { background: #8e2a26; transform: scale(1.05); }

        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 10px; color: black; font-weight: 600; font-size: 16px; }

        select, input {
            width: 100%; padding: 15px; border: 2px solid #ddd;
            border-radius: 10px; font-size: 16px;
            font-family: 'Poppins', sans-serif; color: black;
            background: white; transition: all 0.3s;
        }
        select:focus, input:focus { outline: none; border-color: #b8342f; box-shadow: 0 0 0 3px rgba(184,52,47,0.1); }

        /* ‚îÄ‚îÄ GRID STYLES ‚îÄ‚îÄ */
        .grid-wrapper { margin-top: 20px; }

        .grid-info {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; flex-wrap: wrap; gap: 10px;
        }
        .grid-info-text { font-size: 14px; color: #555; font-weight: 500; }
        .grid-info-text span { color: #b8342f; font-weight: 700; }

        .grid-table-wrap { overflow-x: auto; border-radius: 12px; border: 2px solid #e0e0e0; }

        table { width: 100%; border-collapse: collapse; min-width: 700px; }

        thead tr { background: #b8342f; }
        thead th {
            padding: 14px 12px; color: white; font-weight: 600;
            font-size: 13px; text-align: left; white-space: nowrap;
        }
        thead th:first-child { border-radius: 10px 0 0 0; }
        thead th:last-child { border-radius: 0 10px 0 0; }

        tbody tr { border-bottom: 1px solid #eee; transition: background 0.15s; }
        tbody tr:hover { background: #fff8f8; }
        tbody tr:last-child { border-bottom: none; }

        tbody td { padding: 8px 10px; vertical-align: middle; }

        .item-name-cell { font-weight: 600; font-size: 14px; color: #222; }
        .unit-badge {
            display: inline-block; background: #fff0f0; color: #b8342f;
            border: 1px solid #f5c6c6; border-radius: 6px;
            padding: 2px 8px; font-size: 12px; font-weight: 600; margin-top: 2px;
        }

        .grid-input {
            width: 100%; padding: 8px 10px; border: 1.5px solid #ddd;
            border-radius: 8px; font-size: 14px; font-family: 'Poppins', sans-serif;
            color: black; background: white; transition: border-color 0.2s;
        }
        .grid-input:focus { outline: none; border-color: #b8342f; background: #fff8f8; }
        .grid-input.filled { border-color: #28a745; background: #f8fff9; }
        .grid-input.error-field { border-color: #dc3545 !important; background: #fff5f5 !important; }

        .row-status {
            font-size: 11px; font-weight: 600; text-align: center;
            padding: 3px 8px; border-radius: 20px; white-space: nowrap;
        }
        .row-status.empty { color: #aaa; background: #f5f5f5; }
        .row-status.partial { color: #e67e22; background: #fef9f0; }
        .row-status.ready { color: #27ae60; background: #eafaf1; }
        .row-status.existing { color: #2980b9; background: #eaf4fc; }

        /* Pagination */
        .pagination {
            display: flex; justify-content: center; align-items: center;
            gap: 8px; margin-top: 20px; flex-wrap: wrap;
        }
        .page-btn {
            padding: 8px 16px; border: 2px solid #b8342f; border-radius: 8px;
            background: white; color: #b8342f; font-weight: 600; font-size: 14px;
            cursor: pointer; transition: all 0.2s; font-family: 'Poppins', sans-serif;
        }
        .page-btn:hover, .page-btn.active { background: #b8342f; color: white; }
        .page-btn:disabled { border-color: #ddd; color: #aaa; cursor: not-allowed; background: white; }
        .page-info { font-size: 14px; color: #555; font-weight: 500; padding: 0 8px; }

        /* Submit area */
        .submit-area { margin-top: 30px; }
        .submit-summary {
            background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px;
            padding: 16px 20px; margin-bottom: 16px;
            display: flex; gap: 20px; flex-wrap: wrap; align-items: center;
        }
        .summary-item { font-size: 14px; font-weight: 600; color: #555; }
        .summary-item span { color: #b8342f; font-size: 18px; }

        .submit-btn {
            width: 100%; background: #b8342f; color: white; border: none;
            padding: 20px; border-radius: 15px; font-size: 20px;
            font-weight: 700; cursor: pointer; transition: all 0.3s;
            text-transform: uppercase; letter-spacing: 1px; margin-top: 10px;
            font-family: 'Poppins', sans-serif;
        }
        .submit-btn:hover { background: #8e2a26; transform: translateY(-3px); box-shadow: 0 10px 25px rgba(184,52,47,0.4); }
        .submit-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        .clear-btn {
            width: 100%; background: white; color: #b8342f;
            border: 2px solid #b8342f; padding: 14px;
            border-radius: 12px; font-size: 16px; font-weight: 600;
            cursor: pointer; transition: all 0.3s; margin-top: 10px;
            font-family: 'Poppins', sans-serif;
        }
        .clear-btn:hover { background: #fff0f0; }

        /* Status messages */
        .status-message { padding: 15px 25px; border-radius: 10px; margin-bottom: 20px; font-weight: 600; display: none; animation: slideIn 0.3s ease-out; }
        .status-message.success { background: #d4edda; color: #155724; border-left: 5px solid #28a745; display: block; }
        .status-message.error { background: #f8d7da; color: #721c24; border-left: 5px solid #dc3545; display: block; }
        .status-message.info { background: #d1ecf1; color: #0c5460; border-left: 5px solid #17a2b8; display: block; }

        /* Loader */
        .loader-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;
        }
        .loader-overlay.active { display: flex; }
        .loader-content { background: white; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .spinner { width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid #b8342f; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-text { color: #b8342f; font-size: 18px; font-weight: 600; }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .toast {
            background: white; padding: 16px 24px; border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 12px;
            min-width: 300px; max-width: 500px;
            animation: slideInRight 0.3s ease-out; pointer-events: auto;
            border-left: 5px solid;
        }
        .toast.success { border-left-color: #28a745; background: #d4edda; }
        .toast.error { border-left-color: #dc3545; background: #f8d7da; }
        .toast.info { border-left-color: #17a2b8; background: #d1ecf1; }
        .toast.warning { border-left-color: #ffc107; background: #fff3cd; }
        .toast-icon { font-size: 24px; flex-shrink: 0; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 700; font-size: 16px; margin-bottom: 4px; }
        .toast.success .toast-title { color: #155724; }
        .toast.error .toast-title { color: #721c24; }
        .toast.info .toast-title { color: #0c5460; }
        .toast.warning .toast-title { color: #856404; }
        .toast-message { font-size: 14px; line-height: 1.4; }
        .toast.success .toast-message { color: #155724; }
        .toast.error .toast-message { color: #721c24; }
        .toast.info .toast-message { color: #0c5460; }
        .toast.warning .toast-message { color: #856404; }
        .toast-close {
            background: none; border: none; font-size: 20px; cursor: pointer;
            padding: 0; width: 24px; height: 24px; display: flex;
            align-items: center; justify-content: center;
            border-radius: 50%; transition: background 0.2s;
            color: inherit; opacity: 0.6;
        }
        .toast-close:hover { opacity: 1; background: rgba(0,0,0,0.1); }
        @keyframes slideInRight { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
        .toast.hiding { animation: slideOutRight 0.3s ease-out forwards; }

        .setup-box { background: white; border: 3px solid #b8342f; border-radius: 20px; padding: 30px; margin-bottom: 30px; }
        .setup-box h3 { color: #b8342f; font-size: 24px; margin-bottom: 15px; }
        .setup-box input { margin-bottom: 10px; }
        .setup-box button { background: #b8342f; color: white; border: none; padding: 12px 30px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-family: 'Poppins', sans-serif; }
        .setup-box button:hover { background: #8e2a26; }

        /* Touch-friendly improvements */
        button, .main-button, select, input {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        button:active, .main-button:active { opacity: 0.9; }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 10px; }
            .header { padding: 20px 15px; margin-bottom: 20px; }
            .header h1 { font-size: 32px; letter-spacing: 1px; }
            .header p { font-size: 14px; }
            .date-display { font-size: 16px; padding: 12px 20px; margin-bottom: 20px; }
            .main-buttons { grid-template-columns: 1fr; gap: 15px; margin-bottom: 30px; }
            .main-button { padding: 40px 30px; font-size: 22px; }
            .form-container { padding: 20px; border-radius: 15px; }
            .form-header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .form-header h2 { font-size: 24px; }
            .close-btn { width: 100%; padding: 14px; }
            label { font-size: 15px; }
            select, input, textarea { font-size: 16px; padding: 14px; }
            .grid-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .grid-input { font-size: 16px; padding: 10px; }
            .submit-btn, .clear-btn { padding: 16px; font-size: 16px; }
            .submit-area { flex-direction: column; gap: 15px; }
            .submit-summary { flex-direction: column; gap: 8px; }
            .setup-box { padding: 20px; border-width: 2px; }
            .setup-box h3 { font-size: 20px; }
            .toast-container { top: 10px; left: 10px; right: 10px; }
            .toast { min-width: auto; padding: 14px 18px; }
            .toast-icon { font-size: 20px; }
            .toast-title { font-size: 15px; }
            .toast-message { font-size: 13px; }
            .loader-content { padding: 30px; }
            .spinner { width: 50px; height: 50px; }
            .loader-text { font-size: 16px; }
            .pagination { flex-wrap: wrap; gap: 8px; }
            .page-btn { padding: 8px 12px; font-size: 14px; }
            .cat-label { font-size: 14px; padding: 6px 12px; }
            .grid-info-text { font-size: 13px; }
        }

        @media (max-width: 480px) {
            .header h1 { font-size: 28px; }
            .main-button { padding: 35px 25px; font-size: 20px; }
            .form-header h2 { font-size: 22px; }
            .form-container { padding: 15px; }
            .date-display { font-size: 14px; }
        }

        @media (max-width: 768px) and (orientation: landscape) {
            .header h1 { font-size: 28px; }
            .main-button { padding: 30px 25px; font-size: 20px; }
            .loader-content { padding: 25px; }
        }

        @media (hover: none) and (pointer: coarse) {
            select, input, textarea, button { min-height: 44px; }
            .main-button { min-height: 80px; }
            .form-group { margin-bottom: 25px; }
            .page-btn { min-height: 44px; min-width: 44px; }
        }

        /* Category label chip */
        .cat-label {
            display: inline-flex; align-items: center; gap: 6px;
            background: #fff0f0; border: 1.5px solid #f5c6c6;
            border-radius: 8px; padding: 8px 14px;
            font-size: 14px; font-weight: 600; color: #b8342f;
            margin-bottom: 16px;
        }

        .no-items-msg { text-align: center; padding: 40px; color: #aaa; font-size: 16px; }
    </style>
</head>
<body>
<div class="container">

    <!-- Header -->
    <div class="header">
        <h1>üçΩÔ∏è HOTSPOT</h1>
        <p>Restaurant Inventory Management</p>
    </div>

    <!-- Setup -->
    <div class="setup-box" id="setupBox">
        <h3>‚öôÔ∏è Setup Required</h3>
        <p style="margin-bottom:15px;color:black;">Enter your Google Apps Script Web App URL to get started:</p>
        <input type="url" id="apiUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
        <button onclick="saveApiUrl()">Save & Continue</button>
    </div>

    <!-- Date -->
    <div class="date-display" id="dateDisplay"></div>

    <!-- Main Buttons -->
    <div class="main-buttons" id="mainButtons" style="display:none;">
        <button class="main-button" onclick="showPurchaseForm()">üì¶ Add Purchase</button>
        <button class="main-button" onclick="showStockForm()">üìä Update Stock</button>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         PURCHASE FORM
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="form-container" id="purchaseForm">
        <div class="form-header">
            <h2>üì¶ Add Purchase</h2>
            <button class="close-btn" onclick="closeForm('purchaseForm')">‚úï Close</button>
        </div>

        <div class="status-message" id="purchaseStatus"></div>

        <div class="form-group">
            <label>Category:</label>
            <select id="purchaseCategory" onchange="loadPurchaseGrid()">
                <option value="">-- Select Category --</option>
            </select>
        </div>

        <!-- Grid area -->
        <div class="grid-wrapper" id="purchaseGridWrapper" style="display:none;">
            <div class="cat-label" id="purchaseCatLabel">üìÇ Category</div>
            <div class="grid-info">
                <div class="grid-info-text">
                    Showing <span id="purchasePageRange">-</span> of <span id="purchaseTotalItems">-</span> items &nbsp;|&nbsp;
                    <span id="purchaseFilledCount">0</span> rows filled
                </div>
                <div style="font-size:13px;color:#888;">Fill in the rows you want to submit ‚Äî leave others blank</div>
            </div>

            <div class="grid-table-wrap">
                <table id="purchaseGrid">
                    <thead>
                        <tr>
                            <th style="width:30px;">#</th>
                            <th>Item Name</th>
                            <th style="width:130px;">Current Qty</th>
                            <th style="width:130px;">Purchase Qty</th>
                            <th style="width:130px;">Unit Price (‚Çπ)</th>
                            <th style="width:90px;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="purchaseGridBody"></tbody>
                </table>
            </div>

            <div class="pagination" id="purchasePagination"></div>

            <div class="submit-area">
                <div class="submit-summary">
                    <div class="summary-item">Total items to submit: <span id="purchaseSubmitCount">0</span></div>
                    <div class="summary-item">New entries: <span id="purchaseNewCount">0</span></div>
                    <div class="summary-item">Updates: <span id="purchaseUpdateCount">0</span></div>
                </div>
                <button class="submit-btn" id="purchaseSubmitBtn" onclick="submitPurchaseBatch()">
                    ‚úÖ Submit All Purchases
                </button>
                <button class="clear-btn" onclick="clearPurchaseGrid()">üóëÔ∏è Clear All Entries</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         STOCK FORM
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="form-container" id="stockForm">
        <div class="form-header">
            <h2>üìä Update Stock</h2>
            <button class="close-btn" onclick="closeForm('stockForm')">‚úï Close</button>
        </div>

        <div class="status-message" id="stockStatus"></div>

        <div class="form-group">
            <label>Category:</label>
            <select id="stockCategory" onchange="loadStockGrid()">
                <option value="">-- Select Category --</option>
            </select>
        </div>

        <!-- Grid area -->
        <div class="grid-wrapper" id="stockGridWrapper" style="display:none;">
            <div class="cat-label" id="stockCatLabel">üìÇ Category</div>
            <div class="grid-info">
                <div class="grid-info-text">
                    Showing <span id="stockPageRange">-</span> of <span id="stockTotalItems">-</span> items &nbsp;|&nbsp;
                    <span id="stockFilledCount">0</span> rows filled
                </div>
                <div style="font-size:13px;color:#888;">Fill in the rows you want to submit ‚Äî leave others blank</div>
            </div>

            <div class="grid-table-wrap">
                <table id="stockGrid">
                    <thead>
                        <tr>
                            <th style="width:30px;">#</th>
                            <th>Item Name</th>
                            <th style="width:160px;">Quantity</th>
                            <th style="width:90px;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="stockGridBody"></tbody>
                </table>
            </div>

            <div class="pagination" id="stockPagination"></div>

            <div class="submit-area">
                <div class="submit-summary">
                    <div class="summary-item">Total items to submit: <span id="stockSubmitCount">0</span></div>
                    <div class="summary-item">New entries: <span id="stockNewCount">0</span></div>
                    <div class="summary-item">Updates: <span id="stockUpdateCount">0</span></div>
                </div>
                <button class="submit-btn" id="stockSubmitBtn" onclick="submitStockBatch()">
                    ‚úÖ Submit All Stock Updates
                </button>
                <button class="clear-btn" onclick="clearStockGrid()">üóëÔ∏è Clear All Entries</button>
            </div>
        </div>
    </div>
</div>

<!-- Loader -->
<div class="loader-overlay" id="loaderOverlay">
    <div class="loader-content">
        <div class="spinner"></div>
        <div class="loader-text" id="loaderText">Loading...</div>
    </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Get API URL from Netlify environment variable or localStorage
// In Netlify, set environment variable: APPS_SCRIPT_URL
let API_URL = 'https://script.google.com/macros/s/AKfycbwaOO4CSF1QuSi8naEFLdpmW4nE8uQav3Po33IkwlWqhH-2kuEHfzWRzmTgG9aZ2h5I/exec';

// Try to get from Netlify env var (injected at build time)
if (typeof APPS_SCRIPT_URL !== 'undefined' && APPS_SCRIPT_URL) {
    API_URL = APPS_SCRIPT_URL;
}

let purchaseItems = {};
let stockItems = {};

const ITEMS_PER_PAGE = 10;

// Purchase grid state
let purchaseData = [];      // all items in selected category
let purchasePage = 1;
let purchaseExisting = {};  // { itemName: {currentQty, purchaseQty, unitPrice} }
let purchaseEntries = {};   // { itemName: {currentQty, purchaseQty, unitPrice} } ‚Äî user input

// Stock grid state
let stockData = [];
let stockPage = 1;
let stockExisting = {};     // { itemName: quantity }
let stockEntries = {};      // { itemName: quantity }

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// LOADER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLoader(msg = 'Loading...') {
    document.getElementById('loaderText').textContent = msg;
    document.getElementById('loaderOverlay').classList.add('active');
}
function hideLoader() {
    document.getElementById('loaderOverlay').classList.remove('active');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
    updateDate();
    
    // Priority: 1. Netlify env var, 2. localStorage, 3. User input
    if (API_URL) {
        // URL from Netlify environment variable
        document.getElementById('setupBox').style.display = 'none';
        document.getElementById('mainButtons').style.display = 'grid';
        loadItemsData();
    } else {
        // Fall back to localStorage
        const savedUrl = localStorage.getItem('hotspotApiUrl');
        if (savedUrl) {
            document.getElementById('apiUrl').value = savedUrl;
            API_URL = savedUrl;
            document.getElementById('setupBox').style.display = 'none';
            document.getElementById('mainButtons').style.display = 'grid';
            loadItemsData();
        }
    }
});

function updateDate() {
    const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('en-US', opts);
}

function saveApiUrl() {
    const url = document.getElementById('apiUrl').value.trim();
    if (!url) { alert('Please enter the Apps Script URL'); return; }
    localStorage.setItem('hotspotApiUrl', url);
    API_URL = url;
    document.getElementById('setupBox').style.display = 'none';
    document.getElementById('mainButtons').style.display = 'grid';
    loadItemsData();
}

async function loadItemsData() {
    showLoader('Loading items...');
    try {
        const [pRes, sRes] = await Promise.all([
            fetch(API_URL + '?action=getItems'),
            fetch(API_URL + '?action=getStockItems')
        ]);
        const pData = await pRes.json();
        const sData = await sRes.json();

        if (pData.status === 'success') {
            purchaseItems = pData.items;
            populateCategories('purchaseCategory', Object.keys(purchaseItems));
        }
        if (sData.status === 'success') {
            stockItems = sData.items;
            populateCategories('stockCategory', Object.keys(stockItems));
        }
    } catch (e) {
        console.error('Error loading items:', e);
    } finally {
        hideLoader();
    }
}

function populateCategories(selectId, categories) {
    const sel = document.getElementById(selectId);
    categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        sel.appendChild(opt);
    });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FORM SHOW / HIDE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPurchaseForm() {
    document.getElementById('purchaseForm').classList.add('active');
    document.getElementById('stockForm').classList.remove('active');
}
function showStockForm() {
    document.getElementById('stockForm').classList.add('active');
    document.getElementById('purchaseForm').classList.remove('active');
}
function closeForm(id) {
    document.getElementById(id).classList.remove('active');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PURCHASE GRID
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadPurchaseGrid() {
    const cat = document.getElementById('purchaseCategory').value;
    if (!cat) { document.getElementById('purchaseGridWrapper').style.display = 'none'; return; }

    purchaseData = purchaseItems[cat] || [];
    purchasePage = 1;
    purchaseEntries = {};
    purchaseExisting = {};

    document.getElementById('purchaseCatLabel').textContent = 'üìÇ ' + cat;
    document.getElementById('purchaseTotalItems').textContent = purchaseData.length;
    document.getElementById('purchaseGridWrapper').style.display = 'block';

    // Fetch existing today's entries for this category
    showLoader('Checking today\'s entries...');
    try {
        const res = await fetch(API_URL + '?action=getCategoryPurchase&category=' + encodeURIComponent(cat));
        const result = await res.json();
        if (result.status === 'success' && result.items) {
            purchaseExisting = result.items; // { itemName: {currentQty, purchaseQty, unitPrice} }
        }
    } catch (e) { console.warn('Could not load existing entries', e); }
    finally { hideLoader(); }

    renderPurchasePage();
}

function renderPurchasePage() {
    const tbody = document.getElementById('purchaseGridBody');
    tbody.innerHTML = '';

    const total = purchaseData.length;
    const totalPages = Math.ceil(total / ITEMS_PER_PAGE);
    const start = (purchasePage - 1) * ITEMS_PER_PAGE;
    const end = Math.min(start + ITEMS_PER_PAGE, total);
    const pageItems = purchaseData.slice(start, end);

    document.getElementById('purchasePageRange').textContent = `${start + 1}‚Äì${end}`;

    pageItems.forEach((item, idx) => {
        const globalIdx = start + idx;
        const existing = purchaseExisting[item.name];
        const entry = purchaseEntries[item.name] || {};

        const tr = document.createElement('tr');
        tr.dataset.itemName = item.name;
        tr.dataset.unit = item.unit;

        // Pre-fill from existing today or from user input
        const cQty  = entry.currentQty  !== undefined ? entry.currentQty  : (existing ? existing.currentQty  : '');
        const pQty  = entry.purchaseQty !== undefined ? entry.purchaseQty : (existing ? existing.purchaseQty : '');
        const uPrc  = entry.unitPrice   !== undefined ? entry.unitPrice   : (existing ? existing.unitPrice   : '');

        tr.innerHTML = `
            <td style="color:#aaa;font-size:13px;text-align:center;">${globalIdx + 1}</td>
            <td>
                <div class="item-name-cell">${item.name}</div>
                <div><span class="unit-badge">${item.unit}</span></div>
            </td>
            <td><input class="grid-input" type="number" step="0.01" min="0" placeholder="0.00"
                    value="${cQty}"
                    data-field="currentQty" data-item="${item.name}"
                    oninput="onPurchaseInput(this)" onchange="onPurchaseInput(this)"></td>
            <td><input class="grid-input" type="number" step="0.01" min="0" placeholder="0.00"
                    value="${pQty}"
                    data-field="purchaseQty" data-item="${item.name}"
                    oninput="onPurchaseInput(this)" onchange="onPurchaseInput(this)"></td>
            <td><input class="grid-input" type="number" step="0.01" min="0" placeholder="0.00"
                    value="${uPrc}"
                    data-field="unitPrice" data-item="${item.name}"
                    oninput="onPurchaseInput(this)" onchange="onPurchaseInput(this)"></td>
            <td><span class="row-status" id="ps-${item.name.replace(/[^a-zA-Z0-9]/g,'_')}">‚Äî</span></td>
        `;
        tbody.appendChild(tr);

        // Set initial styling
        updatePurchaseRowStatus(item.name);
        styleInputs(tr);
    });

    renderPurchasePagination(totalPages);
    updatePurchaseSummary();
}

function onPurchaseInput(input) {
    const itemName = input.dataset.item;
    const field = input.dataset.field;
    const val = input.value;

    if (!purchaseEntries[itemName]) purchaseEntries[itemName] = {};
    purchaseEntries[itemName][field] = val;

    styleInputs(input.closest('tr'));
    updatePurchaseRowStatus(itemName);
    updatePurchaseSummary();
}

function updatePurchaseRowStatus(itemName) {
    const entry = purchaseEntries[itemName] || {};
    const existing = purchaseExisting[itemName];
    const safeId = itemName.replace(/[^a-zA-Z0-9]/g,'_');
    const el = document.getElementById('ps-' + safeId);
    if (!el) return;

    const hasCurrentQty  = entry.currentQty  !== '' && entry.currentQty  !== undefined;
    const hasPurchaseQty = entry.purchaseQty !== '' && entry.purchaseQty !== undefined;
    const hasUnitPrice   = entry.unitPrice   !== '' && entry.unitPrice   !== undefined;

    const filledCount = [hasCurrentQty, hasPurchaseQty, hasUnitPrice].filter(Boolean).length;

    if (filledCount === 0) {
        if (existing) {
            el.textContent = 'üìù Existing'; el.className = 'row-status existing';
        } else {
            el.textContent = '‚Äî'; el.className = 'row-status empty';
        }
    } else if (filledCount < 3) {
        el.textContent = '‚ö† Partial'; el.className = 'row-status partial';
    } else {
        el.textContent = existing ? '‚úè Update' : '‚úÖ Ready'; el.className = 'row-status ready';
    }
}

function updatePurchaseSummary() {
    let filled = 0, newEntries = 0, updates = 0;
    Object.keys(purchaseEntries).forEach(name => {
        const e = purchaseEntries[name];
        if (e.currentQty !== '' && e.currentQty !== undefined &&
            e.purchaseQty !== '' && e.purchaseQty !== undefined &&
            e.unitPrice !== '' && e.unitPrice !== undefined) {
            filled++;
            if (purchaseExisting[name]) updates++;
            else newEntries++;
        }
    });
    document.getElementById('purchaseFilledCount').textContent = filled;
    document.getElementById('purchaseSubmitCount').textContent = filled;
    document.getElementById('purchaseNewCount').textContent = newEntries;
    document.getElementById('purchaseUpdateCount').textContent = updates;
}

function renderPurchasePagination(totalPages) {
    const pg = document.getElementById('purchasePagination');
    pg.innerHTML = '';
    if (totalPages <= 1) return;

    const prev = document.createElement('button');
    prev.className = 'page-btn';
    prev.textContent = '‚Üê Prev';
    prev.disabled = purchasePage === 1;
    prev.onclick = () => { savePurchasePageInputs(); purchasePage--; renderPurchasePage(); };
    pg.appendChild(prev);

    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.className = 'page-btn' + (i === purchasePage ? ' active' : '');
        btn.textContent = i;
        btn.onclick = ((page) => () => { savePurchasePageInputs(); purchasePage = page; renderPurchasePage(); })(i);
        pg.appendChild(btn);
    }

    const next = document.createElement('button');
    next.className = 'page-btn';
    next.textContent = 'Next ‚Üí';
    next.disabled = purchasePage === totalPages;
    next.onclick = () => { savePurchasePageInputs(); purchasePage++; renderPurchasePage(); };
    pg.appendChild(next);

    const info = document.createElement('span');
    info.className = 'page-info';
    info.textContent = `Page ${purchasePage} of ${totalPages}`;
    pg.appendChild(info);
}

function savePurchasePageInputs() {
    // Values are saved live via oninput ‚Äî this is a safety flush
    document.querySelectorAll('#purchaseGridBody tr').forEach(tr => {
        const itemName = tr.dataset.itemName;
        if (!itemName) return;
        if (!purchaseEntries[itemName]) purchaseEntries[itemName] = {};
        tr.querySelectorAll('.grid-input').forEach(inp => {
            purchaseEntries[itemName][inp.dataset.field] = inp.value;
        });
    });
}

function clearPurchaseGrid() {
    purchaseEntries = {};
    renderPurchasePage();
}

async function submitPurchaseBatch() {
    savePurchasePageInputs();

    const cat = document.getElementById('purchaseCategory').value;
    const category = cat;

    // Collect fully filled rows
    const batch = [];
    purchaseData.forEach(item => {
        const e = purchaseEntries[item.name] || {};
        if (e.currentQty !== '' && e.currentQty !== undefined &&
            e.purchaseQty !== '' && e.purchaseQty !== undefined &&
            e.unitPrice !== '' && e.unitPrice !== undefined) {
            batch.push({
                category,
                itemName: item.name,
                unit: item.unit,
                currentQty: e.currentQty,
                purchaseQty: e.purchaseQty,
                unitPrice: e.unitPrice,
                isUpdate: !!purchaseExisting[item.name]
            });
        }
    });

    if (batch.length === 0) {
        showToast('No Data Entered', 'Please fill at least one complete row before submitting', 'warning');
        return;
    }

    // Check for partial rows and warn
    let partials = 0;
    purchaseData.forEach(item => {
        const e = purchaseEntries[item.name] || {};
        const vals = [e.currentQty, e.purchaseQty, e.unitPrice].filter(v => v !== '' && v !== undefined);
        if (vals.length > 0 && vals.length < 3) partials++;
    });
    if (partials > 0) {
        if (!confirm(`${partials} row(s) are partially filled and will be skipped. Continue submitting ${batch.length} complete row(s)?`)) return;
    }

    const btn = document.getElementById('purchaseSubmitBtn');
    btn.disabled = true;
    btn.textContent = `‚è≥ Submitting ${batch.length} items...`;
    showLoader(`Submitting ${batch.length} purchases...`);

    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ action: 'addPurchaseBatch', items: batch })
        });
        const data = await res.json();

        if (data.status === 'success') {
            const added = data.added || 0;
            const updated = data.updated || 0;
            showToast(
                'Purchases Submitted!',
                `${added} new entries added, ${updated} entries updated`,
                'success',
                5000
            );
            showStatus('purchaseStatus',
                `‚úÖ Success! ${added} new entries added, ${updated} entries updated.`, 'success');
            purchaseEntries = {};
            // Reload existing to reflect new state
            const res2 = await fetch(API_URL + '?action=getCategoryPurchase&category=' + encodeURIComponent(cat));
            const r2 = await res2.json();
            if (r2.status === 'success') purchaseExisting = r2.items || {};
            renderPurchasePage();
        } else {
            showToast('Submission Failed', data.message || 'Failed to submit purchases', 'error');
            showStatus('purchaseStatus', '‚ùå Error: ' + data.message, 'error');
        }
    } catch (e) {
        showToast('Connection Error', e.message || 'Failed to connect to server', 'error');
        showStatus('purchaseStatus', '‚ùå Error: ' + e.message, 'error');
    } finally {
        hideLoader();
        btn.disabled = false;
        btn.textContent = '‚úÖ Submit All Purchases';
    }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STOCK GRID
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadStockGrid() {
    const cat = document.getElementById('stockCategory').value;
    if (!cat) { document.getElementById('stockGridWrapper').style.display = 'none'; return; }

    stockData = stockItems[cat] || [];
    stockPage = 1;
    stockEntries = {};
    stockExisting = {};

    document.getElementById('stockCatLabel').textContent = 'üìÇ ' + cat;
    document.getElementById('stockTotalItems').textContent = stockData.length;
    document.getElementById('stockGridWrapper').style.display = 'block';

    showLoader('Checking today\'s stock entries...');
    try {
        const res = await fetch(API_URL + '?action=getCategoryStock&category=' + encodeURIComponent(cat));
        const result = await res.json();
        if (result.status === 'success' && result.items) {
            stockExisting = result.items; // { itemName: quantity }
        }
    } catch (e) { console.warn('Could not load existing stock', e); }
    finally { hideLoader(); }

    renderStockPage();
}

function renderStockPage() {
    const tbody = document.getElementById('stockGridBody');
    tbody.innerHTML = '';

    const total = stockData.length;
    const totalPages = Math.ceil(total / ITEMS_PER_PAGE);
    const start = (stockPage - 1) * ITEMS_PER_PAGE;
    const end = Math.min(start + ITEMS_PER_PAGE, total);
    const pageItems = stockData.slice(start, end);

    document.getElementById('stockPageRange').textContent = `${start + 1}‚Äì${end}`;

    pageItems.forEach((item, idx) => {
        const globalIdx = start + idx;
        const existing = stockExisting[item.name];
        const entry = stockEntries[item.name] || {};

        const qty = entry.quantity !== undefined ? entry.quantity : (existing !== undefined ? existing : '');

        const tr = document.createElement('tr');
        tr.dataset.itemName = item.name;
        tr.dataset.unit = item.unit;

        tr.innerHTML = `
            <td style="color:#aaa;font-size:13px;text-align:center;">${globalIdx + 1}</td>
            <td>
                <div class="item-name-cell">${item.name}</div>
                <div><span class="unit-badge">${item.unit}</span></div>
            </td>
            <td><input class="grid-input" type="number" step="0.01" min="0" placeholder="0.00"
                    value="${qty}"
                    data-field="quantity" data-item="${item.name}"
                    oninput="onStockInput(this)" onchange="onStockInput(this)"></td>
            <td><span class="row-status" id="ss-${item.name.replace(/[^a-zA-Z0-9]/g,'_')}">‚Äî</span></td>
        `;
        tbody.appendChild(tr);

        updateStockRowStatus(item.name);
        styleInputs(tr);
    });

    renderStockPagination(totalPages);
    updateStockSummary();
}

function onStockInput(input) {
    const itemName = input.dataset.item;
    const val = input.value;

    if (!stockEntries[itemName]) stockEntries[itemName] = {};
    stockEntries[itemName].quantity = val;

    styleInputs(input.closest('tr'));
    updateStockRowStatus(itemName);
    updateStockSummary();
}

function updateStockRowStatus(itemName) {
    const entry = stockEntries[itemName] || {};
    const existing = stockExisting[itemName];
    const safeId = itemName.replace(/[^a-zA-Z0-9]/g,'_');
    const el = document.getElementById('ss-' + safeId);
    if (!el) return;

    const hasQty = entry.quantity !== '' && entry.quantity !== undefined;

    if (!hasQty) {
        if (existing !== undefined) {
            el.textContent = 'üìù Existing'; el.className = 'row-status existing';
        } else {
            el.textContent = '‚Äî'; el.className = 'row-status empty';
        }
    } else {
        el.textContent = existing !== undefined ? '‚úè Update' : '‚úÖ Ready';
        el.className = 'row-status ready';
    }
}

function updateStockSummary() {
    let filled = 0, newEntries = 0, updates = 0;
    Object.keys(stockEntries).forEach(name => {
        const e = stockEntries[name];
        if (e.quantity !== '' && e.quantity !== undefined) {
            filled++;
            if (stockExisting[name] !== undefined) updates++;
            else newEntries++;
        }
    });
    document.getElementById('stockFilledCount').textContent = filled;
    document.getElementById('stockSubmitCount').textContent = filled;
    document.getElementById('stockNewCount').textContent = newEntries;
    document.getElementById('stockUpdateCount').textContent = updates;
}

function renderStockPagination(totalPages) {
    const pg = document.getElementById('stockPagination');
    pg.innerHTML = '';
    if (totalPages <= 1) return;

    const prev = document.createElement('button');
    prev.className = 'page-btn';
    prev.textContent = '‚Üê Prev';
    prev.disabled = stockPage === 1;
    prev.onclick = () => { saveStockPageInputs(); stockPage--; renderStockPage(); };
    pg.appendChild(prev);

    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.className = 'page-btn' + (i === stockPage ? ' active' : '');
        btn.textContent = i;
        btn.onclick = ((page) => () => { saveStockPageInputs(); stockPage = page; renderStockPage(); })(i);
        pg.appendChild(btn);
    }

    const next = document.createElement('button');
    next.className = 'page-btn';
    next.textContent = 'Next ‚Üí';
    next.disabled = stockPage === totalPages;
    next.onclick = () => { saveStockPageInputs(); stockPage++; renderStockPage(); };
    pg.appendChild(next);

    const info = document.createElement('span');
    info.className = 'page-info';
    info.textContent = `Page ${stockPage} of ${totalPages}`;
    pg.appendChild(info);
}

function saveStockPageInputs() {
    document.querySelectorAll('#stockGridBody tr').forEach(tr => {
        const itemName = tr.dataset.itemName;
        if (!itemName) return;
        if (!stockEntries[itemName]) stockEntries[itemName] = {};
        tr.querySelectorAll('.grid-input').forEach(inp => {
            stockEntries[itemName][inp.dataset.field] = inp.value;
        });
    });
}

function clearStockGrid() {
    stockEntries = {};
    renderStockPage();
}

async function submitStockBatch() {
    saveStockPageInputs();

    const cat = document.getElementById('stockCategory').value;

    const batch = [];
    stockData.forEach(item => {
        const e = stockEntries[item.name] || {};
        if (e.quantity !== '' && e.quantity !== undefined) {
            batch.push({
                category: cat,
                itemName: item.name,
                unit: item.unit,
                quantity: e.quantity,
                isUpdate: stockExisting[item.name] !== undefined
            });
        }
    });

    if (batch.length === 0) {
        showToast('No Data Entered', 'Please fill at least one row before submitting', 'warning');
        return;
    }

    const btn = document.getElementById('stockSubmitBtn');
    btn.disabled = true;
    btn.textContent = `‚è≥ Submitting ${batch.length} items...`;
    showLoader(`Submitting ${batch.length} stock updates...`);

    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ action: 'updateStockBatch', items: batch })
        });
        const data = await res.json();

        if (data.status === 'success') {
            const added = data.added || 0;
            const updated = data.updated || 0;
            showToast(
                'Stock Updates Submitted!',
                `${added} new entries added, ${updated} entries updated`,
                'success',
                5000
            );
            showStatus('stockStatus',
                `‚úÖ Success! ${added} new entries added, ${updated} entries updated.`, 'success');
            stockEntries = {};
            const res2 = await fetch(API_URL + '?action=getCategoryStock&category=' + encodeURIComponent(cat));
            const r2 = await res2.json();
            if (r2.status === 'success') stockExisting = r2.items || {};
            renderStockPage();
        } else {
            showToast('Submission Failed', data.message || 'Failed to update stock', 'error');
            showStatus('stockStatus', '‚ùå Error: ' + data.message, 'error');
        }
    } catch (e) {
        showToast('Connection Error', e.message || 'Failed to connect to server', 'error');
        showStatus('stockStatus', '‚ùå Error: ' + e.message, 'error');
    } finally {
        hideLoader();
        btn.disabled = false;
        btn.textContent = '‚úÖ Submit All Stock Updates';
    }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// UTILS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function styleInputs(tr) {
    tr.querySelectorAll('.grid-input').forEach(inp => {
        inp.classList.toggle('filled', inp.value !== '');
    });
}

// Toast notification functions
function showToast(title, message, type = 'info', duration = 4000) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icons = { success: '‚úì', error: '‚úï', info: '‚Ñπ', warning: '‚ö†' };
    toast.innerHTML = `
        <div class="toast-icon">${icons[type] || '‚Ñπ'}</div>
        <div class="toast-content">
            <div class="toast-title">${title}</div>
            ${message ? `<div class="toast-message">${message}</div>` : ''}
        </div>
        <button class="toast-close" onclick="closeToast(this)">√ó</button>
    `;
    container.appendChild(toast);
    setTimeout(() => { closeToast(toast.querySelector('.toast-close')); }, duration);
}

function closeToast(button) {
    const toast = button.parentElement;
    toast.classList.add('hiding');
    setTimeout(() => { toast.remove(); }, 300);
}

function showStatus(id, msg, type) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.className = `status-message ${type}`;
    setTimeout(() => { el.style.display = 'none'; }, 6000);
}
</script>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

</body>
</html>
